// config.c

#include <common.h>
#include <config.h>
#include <F410_FlashPrimitives.h>
#include <crc.h>

// настройки во Flash
static CONFIG code configStored _at_ 0x7a00;

// копия настроек
CONFIG data config;

static uint8_t modified_timer = 0;


void setDefault(void);


// копирование настроек из Flash
void config_init(void)
{
	uint16_t i = sizeof(config);
	uint8_t *ptr = (uint8_t *)&config;
	uint16_t addr = (uint16_t)&configStored;

	while (i--)
		*ptr++ = FLASH_ByteRead(addr++);

	if (crc8((uint8_t *)&config, sizeof(config) - 1) != config.crc)
		setDefault();

	setDefault();
}


// сохранение настроек во Flash и рестарт
void config_store(void)
{
	uint16_t i = sizeof(CONFIG);
	uint8_t *ptr = (uint8_t *)&config;
	uint16_t addr = (uint16_t)&configStored;

	WDT_DISABLE();
	INTERRUPT_DISABLE();

	config.crc = crc8((uint8_t *)&config, sizeof(config) - 1);	// update crc

	FLASH_PageErase(addr);

	while (i--)
		FLASH_ByteWrite(addr++, *ptr++);

	WDT_ENABLE();
	INTERRUPT_ENABLE();
}


// проверка таймера сохранения настроек после модификации
void config_checkModified(void)
{
	if (modified_timer)
	{
		if (--modified_timer == 0)
			config_store();
	}
}


// запуск таймера сохранения настроек после модификации
void config_setModified(void)
{
	modified_timer = 100;
}


static void setDefault(void)
{
	config.addr = 255;
	config.ps0 = 760 * 133.322f;
	config.pd0 = 0;
	config.temp0 = 15 + 273;

	config.kref = 2.0446f;
	config.kps = 2.0059f;
	config.kpd = 2.0058f;

	config.var_a = 0.03f;
	config.var_h = 0.002f;

	config_store();
}

